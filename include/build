
ifndef current-folder
include $(mablung-makefile-path)/include/build
else

# ifndef filter-environment-build-item
# filter-environment-build-item = $(1)
# endif

# filter-build-item =	$(call $\
# 											filter-environment-build-item,$\
# 											$(sort $\
# 												$(strip $\
# 													$(patsubst $\
# 														release/esmodule/%,$\
# 														release/commonjs/%,$\
# 														$(patsubst $\
# 															%.js,$\
# 															%.cjs,$\
# 															$(filter $\
# 																release/esmodule%,$\
# 																$(1)))) $\
# 													$(1))))

include $(mablung-makefile-path)/include/build

# $(info --------------------)
# $(info current-folder ... $(current-folder))
# $(info make-folder ...... $(make-folder))
# $(info build-folder ..... $(build-folder))
# $(info build-item ....... $(build-item))
# $(info --------------------)

ifeq ($(findstring source/esmodule,$(current-folder)),source/esmodule)

build-commonjs-item = $(patsubst $\
												release/esmodule/%,$\
												release/commonjs/%,$\
												$(patsubst $\
													%.js,$\
													%.cjs,$\
													$(build-item)))

build:: $(build-commonjs-item)
	@npx shx true
	
# this rule replaces the same rule in the included makefile
release/%.create:
	$(if $(verbose),@echo create .... $(patsubst %.create,%,$@))
	@npx shx mkdir -p $(patsubst %.create,%,$@)
	$(if $(verbose),@echo create .... $(patsubst release/esmodule/%,release/commonjs/%,$(patsubst %.create,%,$@)))
	@npx shx mkdir -p $(patsubst release/esmodule/%,release/commonjs/%,$(patsubst %.create,%,$@))

release/commonjs/.DS_Store: source/esmodule/.DS_Store
	$(if $(verbose),@echo ignore .... $<)
release/commonjs/%/.DS_Store: source/esmodule/%/.DS_Store
	$(if $(verbose),@echo ignore .... $<)
release/commonjs/.babelrc.json: source/esmodule/.babelrc.json
	$(if $(verbose),@echo ignore .... $<)
release/commonjs/%/.babelrc.json: source/esmodule/%/.babelrc.json
	$(if $(verbose),@echo ignore .... $<)
release/commonjs/.eslintrc.json: source/esmodule/.eslintrc.json
	$(if $(verbose),@echo ignore .... $<)
release/commonjs/%/.eslintrc.json: source/esmodule/%/.eslintrc.json
	$(if $(verbose),@echo ignore .... $<)

release/commonjs/%.cjs: babel-parameter := --env-name commonjs
release/commonjs/%.cjs: source/esmodule/%.js
	$(eval export SOURCE_PATH := $<)
	$(eval export RELEASE_PATH := $@)
	@echo compile ... $@ --source-maps $(or $(source-map),true) $(babel-parameter)
	@npx babel $< --out-file $@ --source-maps $(or $(source-map),true) $(babel-parameter)

release/commonjs/%: source/esmodule/%
	@echo copy ...... $@
	@npx shx cp -R $< $(call trim-folder-path,$@)

ifeq ($(findstring source/esmodule/,$(current-folder)),source/esmodule/)

# this rule is executed after the same rule in the included makefile
copy::
	$(if $(verbose),@echo copy ...... $(patsubst source/esmodule/%,release/commonjs/%,$(current-folder)))
	@npx shx cp -R $(current-folder) $(call trim-folder-path,$(patsubst source/esmodule/%,release//commonjs/%,$(current-folder)))
	$(if $(verbose),@echo delete .... $(patsubst source/esmodule/%,release/commonjs/%,$(current-folder))/makefile)
	@npx shx rm -f $(patsubst source/esmodule/%,release/commonjs/%,$(current-folder))/makefile

endif

else ifeq ($(current-folder),source)

release/esmodule.create:
	$(if $(verbose),@echo create .... $(patsubst %.create,%,$@))
	@npx shx mkdir -p $(patsubst %.create,%,$@)
	$(if $(verbose),@echo create .... $(subst release/esmodule,release/commonjs,$(patsubst %.create,%,$@)))
	@npx shx mkdir -p $(subst release/esmodule,release/commonjs,$(patsubst %.create,%,$@))

endif

release/%.cjs: babel-parameter := --env-name commonjs
release/%.js: babel-parameter := --env-name esmodule

endif
